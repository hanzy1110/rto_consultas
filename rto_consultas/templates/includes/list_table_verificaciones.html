{% extends 'layouts/base.html' %}

{% block content %}
{% load render_table from django_tables2 %}
{% load getattr %}
<h1>{{ context_object_name }}</h1>
<div class="card-body px-0 pt-0 pb-2">
<form method="GET">
  <table width="90%" style="margin-left: 10px;">
    {% comment %} Render the "Nueva Revisi√≥n" button {% endcomment %}
    <tr>
      <td><b>Buscar</b></td>
    </tr>
    <tr>
    {% for field in query_fields %}
        <td>
        <label for={{ ffield }}>{% query_dict parsed_fields field %}</label>
        <input id="{% query_dict ids field %}" type="text" name="{{ field }}" placeholder="Buscar...">
        </td>
    {% endfor %}
    </tr>
    <tr>
    {% for ffield, vals in form_fields.items %}
      <td>
      <label for={{ ffield }}>{% query_dict parsed_fields ffield %}</label>
      <select name="{{ ffield }}" id="{{ ffield }}">
        <option value=""></option>
      {% for val in vals %}
        <option value="{{ val }}">{% query_descriptions descriptions ffield val %}</option>
      {% endfor %}
      </select>
      </td>
    {% endfor %}
    </tr>
    <tr>
      <td>
        <label for="tipo_documento">Tipo Documento<label>
        <select name="tipo_documento" class="combo" style="width: 100px;">
          <option value="-1">Seleccione...</option>
          <option value="DNI">DNI</option>
          <option value="LC">LI</option>
          <option value="LE">LE</option>
          <option value="PAS">PAS</option>
          <option value="CUIT">CUIT</option>
        </select>
      </td>
      <td>
        <label for="numero_documento">Nro. Documento<label>
        <input type="text" name="numero_documento" style="width: 100px" maxlength="11" class="txt" />
      </td>
    </tr>
    <tr>
      <td colspan="4"></td>
    </tr>
  </table>
  <button type="submit" class="btn btn-fill btn-sm btn-primary">Buscar</button>
</form>
</div>
<div class="card-body px-0 pt-0 pb-2">
  <div class="table-responsive p-0">
    {% render_table table %}
  </div>
</div>

{% block script %}
<script>
$(document).ready(function() {
  // Define the date input field selectors
  var dateSelectors = ['#txtFechaD', '#txtFechaH'];

  // Define the license plate input field selector
  var licensePlateSelector = '#txtDominio';

  // Function to format the date value
  function formatDate(input) {
    var value = input.val();
    var formattedValue = '';

    // Remove any non-digit characters from the input value
    var digitsOnly = value.replace(/\D/g, '');

    // Format the date as dd/mm/yyyy
    if (digitsOnly.length >= 8) {
      formattedValue = digitsOnly.replace(/^(\d{2})(\d{2})(\d{4})$/, '$1/$2/$3');
    } else if (digitsOnly.length >= 4) {
      formattedValue = digitsOnly.replace(/^(\d{2})(\d{2})(\d+)$/, '$1/$2/$3');
    } else if (digitsOnly.length >= 2) {
      formattedValue = digitsOnly.replace(/^(\d{2})(\d+)$/, '$1/$2');
    } else {
      formattedValue = digitsOnly;
    }

    // Update the input value with the formatted date
    input.val(formattedValue);
  }

  // Function to format the license plate value
  function formatLicensePlate(input) {
    var value = input.val();
    var formattedValue = '';

    // Remove any non-alphanumeric characters from the input value
    var alphanumericOnly = value.replace(/\W/g, '');

    // Format the license plate
    if (alphanumericOnly.length >= 7) {
      formattedValue = alphanumericOnly.replace(/^(\w{3})(\w{3})(\w+)$/, '$1-$2-$3');
    } else if (alphanumericOnly.length >= 5) {
      formattedValue = alphanumericOnly.replace(/^(\w{2})(\w{3})$/, '$1-$2');
    } else {
      formattedValue = alphanumericOnly;
    }

    // Update the input value with the formatted license plate
    input.val(formattedValue);
  }

  // Attach event handlers to the date input fields
  dateSelectors.forEach(function(selector) {
    $(selector).on('input', function() {
      formatDate($(this));
    });
  });

  // Attach event handler to the license plate input field
  $(licensePlateSelector).on('input', function() {
    formatLicensePlate($(this));
  });
});
</script>
{% endblock %}
{% endblock %}
